Select * from
(
	select tmp2.*,
	IsNULL(round(tmp2.Price - tmp2.ProductOrCategoryDiscount * tmp2.Price / 100, 0), tmp2.Price) as SalePrice,  
	ISNULL(tmp2.ProductOrCategoryDiscount - tmp2.ProductOrCategoryDiscount + 1, 0) as HasDiscount from
	(
		Select tmp1.*, 
		(Select c1.Discount from Categories c1 where c1.code = tmp1.CategoryCode) as CategoryDiscount, 
		(Select c2.Discount from Categories c2 
			where c2.code = (Select c21.ParentCode from Categories c21 where c21.code = tmp1.CategoryCode)
		) as ParentCategoryDiscount,
		ISNULL(tmp1.Discount, 
			   IsNull((Select c1.Discount from Categories c1 where c1.code = tmp1.CategoryCode), 
					   ISNULL(
							   (
								Select c2.Discount from Categories c2 
								where c2.code = (Select c21.ParentCode from Categories c21 where c21.code = tmp1.CategoryCode)
							   ), NULL
							 )
					  )
			 ) as ProductOrCategoryDiscount,
       (Select c3.ParentCode from Categories c3 where c3.Code = tmp1.CategoryCode) as ParentCategoryCode
	   
	   from products tmp1
	) as tmp2 
) as prd 